<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Personalised gamepad streaming :: Gaming on Linux</title><link href=/css/nucleus.css?1627292763 rel=stylesheet><link href=/css/fontawesome-all.min.css?1627292763 rel=stylesheet><link href=/css/hybrid.css?1627292763 rel=stylesheet><link href=/css/featherlight.min.css?1627292763 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1627292763 rel=stylesheet><link href=/css/auto-complete.css?1627292763 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1627292763 rel=stylesheet><link href=/css/theme.css?1627292763 rel=stylesheet><link href=/css/hugo-theme.css?1627292763 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1627292763></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/posts/gamepads/><nav id=sidebar><div id=header-wrapper><div id=header><img src=https://github.com/vaslabs/reviewer-bot/raw/master/images/reviewerbot_256x256.png alt=logo></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1627292763></script><script type=text/javascript src=/js/auto-complete.js?1627292763></script><script type=text/javascript>var baseurl="https://playingplaces.com/"</script><script type=text/javascript src=/js/search.js?1627292763></script></div><section id=homelinks><ul><li><a class=padding href=/><i class="fas fa-home"></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/posts/ title=Posts class="dd-item
parent"><a href=/posts/>Posts</a><ul><li data-nav-id=/posts/intro/ title="Personal remote gaming platform" class=dd-item><a href=/posts/intro/>Personal remote gaming platform</a></li><li data-nav-id=/posts/prerequisites/ title="Personal remote gaming: architecture" class=dd-item><a href=/posts/prerequisites/>Personal remote gaming: architecture</a></li><li data-nav-id=/posts/implementation/ title="Implementing remote gaming" class=dd-item><a href=/posts/implementation/>Implementing remote gaming</a></li><li data-nav-id=/posts/gamepads/ title="Personalised gamepad streaming" class="dd-item active"><a href=/posts/gamepads/>Personalised gamepad streaming</a></li><li data-nav-id=/posts/results/ title=Results class=dd-item><a href=/posts/results/>Results</a></li></ul></li></ul><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/></a>> <a href=/posts/>Posts</a> > Personalised gamepad streaming</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#motivation>Motivation</a></li><li><a href=#solution>Solution</a><ul><li><a href=#my-setup>My setup</a></li><li><a href=#design>Design</a></li><li><a href=#implementation>Implementation</a></li><li><a href=#streaming-the-controllers>Streaming the controllers</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Personalised gamepad streaming</h1><h2 id=motivation>Motivation</h2><p>In my own experience, hot plugging gamepads makes steam a bit unstable on Linux. It can freeze or the steam input may crash.
This is particularly noticeable with remote play. The reason is that every time you connect and disconnect, the virtual controllers
are being destroyed and recreated. This may result in unresponsive games or steam to freeze.</p><p>Some games are also problematic with steam input and, again in my own experience, with dual shock 4 controllers. For example, Assassin&rsquo;s Creed Odyssey doesn&rsquo;t recognise the controllers with steam input ps4 support (something that changed recently). When I emulate them as xpad controllers though the game is able to work with them (by disabling steam input or disabling ps4 support and enabling xbox support).</p><p><img src=/posts/images/allow_xbox_support.png alt=disable_ps4_enable_xbox></p><p>In order to have such games work and avoid instability when remote playing, I decided to create my own infrastructure to support gamepad streaming.</p><h2 id=solution>Solution</h2><h3 id=my-setup>My setup</h3><p>My gaming PC sits in my apartment behind NAT. So connecting to it directly is not an option. Also, when I&rsquo;m travelling, there&rsquo;s no guarantee my portable machine will be reachable from the internet.</p><p>In other words, I need a middleware that&rsquo;s accessible over the internet to help my machines communicate with each other.</p><p>My laptop and gaming pc are running Fedora 34 and I have a high end Android phone which can stream with steam link reliably.</p><p>My solution focuses on communication between my laptop and gaming pc, while I&rsquo;m not really bothered to stream from my phone.</p><h3 id=design>Design</h3><p>The diagram below demonstrates the basic idea of my solution.</p><p><img src=/posts/images/connect_controllers_diagram.jpg alt=connect_controllers></p><p>With this, we basically have permanent controllers connected to the gaming pc which steam sees all the time, so there&rsquo;s no hot plugging going on.
We forward their input from the laptop to the middleware where the gaming pc can pull them. The communication can happen securely over ssh.</p><h3 id=implementation>Implementation</h3><p>I created an ec2 instance (t3.micro) on aws which is on free tier for 1 year. On the eu regions it costs roughly Â£10 per month if you are running it constantly.</p><p>The ec2 instance runs ubuntu and I&rsquo;ve installed ds4drv on it and started it (haven&rsquo;t automated that part yet).</p><p>Initially it was creating devices on event3 and event4 but that changed to event4 and event5. I don&rsquo;t tear it down frequently so I pretty much have these hardcoded for now but the scripts can be improved to detect these automatically (with a similar way as done <a href=https://github.com/vaslabs/home-automation/blob/f49e21d867fb4efee433aaff80ee392cd65cefc3/find_game_proxy.sh#L13>here</a> and <a href=https://github.com/vaslabs/home-automation/blob/f49e21d867fb4efee433aaff80ee392cd65cefc3/find_game_proxy.sh#L18>here</a> but over ssh)</p><p>Now, with the infrastructure ready, we need a convenient way to initiate the connection. You could do it by enabling steam input on remote play
and start a terminal and write the commands but that would be very time consuming . To help me with that, I have an Alexa skill that is configured to understand an intent for connecting gamepads. This essentially, starts ds4drv on the gaming pc, connects via ssh to the middleware and directs the output of /dev/input/eventx (on the middleware) to the /dev/input/eventy (on the gaming pc).</p><p>I have a bunch of aliases to initiate the connection on my laptop (since it&rsquo;s the one I have direct physical access to I don&rsquo;t need anything more than that).</p><p>These aliases and functions help me speed up things:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>alias ps4_as_xbox<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ds4drv --emulate-xpad-wireless --next-controller --emulate-xpad-wireless --hidraw&#39;</span>
alias ps4<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ds4drv --next-controller --hidraw&#39;</span>

alias ps4_as_xbox_four_players<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ds4drv --emulate-xpad-wireless --next-controller --emulate-xpad-wireless --next-controller --emulate-xpad-wireless --next-controller --emulate-xpad-wireless --hidraw&#39;</span>
<span style=color:#66d9ef>function</span> connect_first_controller <span style=color:#f92672>{</span>
  cat /dev/input/event$1 | ssh ubuntu@$CONTROLLER_HOST sudo tee -a /dev/input/event4 &gt;/dev/null
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>function</span> connect_second_controller <span style=color:#f92672>{</span>
  cat /dev/input/event$1 | ssh ubuntu@$CONTROLLER_HOST sudo tee -a /dev/input/event5 &gt;/dev/null
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>function</span> connect_third_controller <span style=color:#f92672>{</span>
  cat /dev/input/event$1 | ssh ubuntu@$CONTROLLER_HOST sudo tee -a /dev/input/event6 &gt;/dev/null
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>function</span> connect_fourth_controller <span style=color:#f92672>{</span>
  cat /dev/input/event$1 | ssh ubuntu@$CONTROLLER_HOST sudo tee -a /dev/input/event7 &gt;/dev/null
<span style=color:#f92672>}</span>
</code></pre></div><p>You can probably notice that I have support for up to 4 controllers. Again, nothing really smart coding wise to reduce duplication
because most of my games don&rsquo;t support more than 4 local coop players. There are also other limitations that make more than 4 inconvenient (
like not having more than 3 friends or because the bluetooth on my laptops motherboard stops behaving nicely after a few controllers are connected.
)</p><p>To get a more idea on streaming controllers (and moving up to 4) <a href=https://github.com/vaslabs/home-automation/pull/1>these are my changes to support 4 controllers</a></p><h3 id=streaming-the-controllers>Streaming the controllers</h3><p>The steps for a reliable connection with the setup above are:</p><ol><li>Start <a href=https://github.com/chrippa/ds4drv>ds4drv</a> on the machine you have physical access to (let&rsquo;s call this, the laptop), emulating xpad and on hidraw mode.</li></ol><p><img src=/posts/images/ds4drv_emulate_xpad.png alt=ds4drv_emulate_xpad></p><ol start=2><li>Connect the controllers normally on the laptop</li><li>Disable device input on the steam link running on the laptop.
<img src=/posts/images/disable_steam_link_input.jpg alt=disable_steam_link_input></li><li>Start remote play</li><li>Send the command for the gaming pc to connect to the middleware (the steps for this are <a href=https://github.com/vaslabs/home-automation/blob/f49e21d867fb4efee433aaff80ee392cd65cefc3/stream_controllers.sh>here</a>)</li></ol><p>Then wait for steam to show that the xbox controllers are connected.</p><p>This was my test to demonstrate it working</p><iframe width=560 height=315 src=https://www.youtube.com/embed/lTGJEHK0MZQ title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/posts/implementation/ title="Implementing remote gaming"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/posts/results/ title=Results style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1627292763></script><script src=/js/perfect-scrollbar.min.js?1627292763></script><script src=/js/perfect-scrollbar.jquery.min.js?1627292763></script><script src=/js/jquery.sticky.js?1627292763></script><script src=/js/featherlight.min.js?1627292763></script><script src=/js/highlight.pack.js?1627292763></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1627292763></script><script src=/js/learn.js?1627292763></script><script src=/js/hugo-learn.js?1627292763></script><script src=/mermaid/mermaid.js?1627292763></script><script>mermaid.initialize({startOnLoad:!0})</script></body></html>